<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Preferring Quantiles to Histograms &#8211; Art is Never Finished</title>
<meta name="description" content="The histogram is most scientists’ tool of choice for viewing the distribution of values of a single variable. But lately I have been exploring an alternative: quantiles (e.g. deciles, percentiles, etc). Viewing data in this way has several advantages to histograms, including robustness to outliers and a freedom from apriori assumptions about the range or smoothing level of the data.

">
<meta name="keywords" content="math, percentile, histogram, python">


<!-- Twitter Cards -->
<meta name="twitter:title" content="Preferring Quantiles to Histograms">
<meta name="twitter:description" content="The histogram is most scientists’ tool of choice for viewing the distribution of values of a single variable. But lately I have been exploring an alternative: quantiles (e.g. deciles, percentiles, etc). Viewing data in this way has several advantages to histograms, including robustness to outliers and a freedom from apriori assumptions about the range or smoothing level of the data.

">
<meta name="twitter:site" content="@ivarthorson">
<meta name="twitter:creator" content="@ivarthorson">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Preferring Quantiles to Histograms">
<meta property="og:description" content="The histogram is most scientists’ tool of choice for viewing the distribution of values of a single variable. But lately I have been exploring an alternative: quantiles (e.g. deciles, percentiles, etc). Viewing data in this way has several advantages to histograms, including robustness to outliers and a freedom from apriori assumptions about the range or smoothing level of the data.

">
<meta property="og:url" content="/blog/percentiles-and-histograms/">
<meta property="og:site_name" content="Art is Never Finished">





<link rel="canonical" href="/blog/percentiles-and-histograms/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Art is Never Finished Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="/assets/js/vendor/html5shiv.min.js"></script>
  <script src="/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="/about/" >About</a></li>
		  
		    
		    <li><a href="/blog/" >Blog</a></li>
		  
		    
		    <li><a href="/project-euler/" >Code</a></li>
		  
		    
		    <li><a href="/search/" >Search</a></li>
		  
		    
		    <li><a href="/tags/" >Tags</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title animated fadeIn"><a href="/">Art is Never Finished</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">...Only Abandoned. – Leonardo da Vinci</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="/tags/#math" title="Pages tagged math">math</a></li><li><a href="/tags/#percentile" title="Pages tagged percentile">percentile</a></li><li><a href="/tags/#histogram" title="Pages tagged histogram">histogram</a></li><li><a href="/tags/#python" title="Pages tagged python">python</a></li>
        </ul>
        
          <h1 class="entry-title">Preferring Quantiles to Histograms</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/ivar.jpg" class="bio-photo" alt="Ivar Thorson bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Ivar Thorson</span></span>
        <span class="entry-date date published"><time datetime="2019-03-12T00:00:00-07:00"><i class="fa fa-calendar-o"></i> March 12, 2019</time></span>
        
        
        
        
      </footer>
      <div class="entry-content">
        <p>The histogram is most scientists’ tool of choice for viewing the distribution of values of a single variable. But lately I have been exploring an alternative: quantiles (e.g. deciles, percentiles, etc). Viewing data in this way has several advantages to histograms, including robustness to outliers and a freedom from apriori assumptions about the range or smoothing level of the data.</p>

<p>This post has some code written in <a href="https://www.python.org">Python</a>. If you don’t have it already, you may want to follow along by <a href="../jupyter-quick-install/">installing Jupyter</a> and opening up a notebook.</p>

<h2 id="generating-artificial-data">Generating Artificial Data</h2>

<p>We’ll begin by inventing an unusual probability distribution with characteristics that will highlight some problems with histograms. We’ll choose a <a href="https://en.wikipedia.org/wiki/Cumulative_distribution_function">cumulative distribution function</a> (CDF), <a href="https://en.wikipedia.org/wiki/Probability_density_function">probability density function</a> (PDF), and inverse CDF that are easy to evaluate analytically. The distribution will be jagged, bimodal, and have a small a blocky sidebands to represent outliers.</p>

<p>Understanding the python code used to produce artificial data is not essential to understand the rest of this article, but the basic trick used in the following code is to pick random points on the Y axis between 0 and 1, draw a horizontal line over to where it intersects the cumulative density function, and then use the intersection’s X coordinate as your random sample. You can easily produce samples from any distribution with this technique.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">unusual_distribution_cdf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="s">'''Returns the cumulative distribution function of an unusual distribution.'''</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>     <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>    <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.98</span><span class="p">):</span> <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">1.96</span><span class="p">):</span> <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">0.98</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>    <span class="k">return</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="k">else</span><span class="p">:</span>            <span class="k">return</span> <span class="mi">1</span>
    
<span class="k">def</span> <span class="nf">unusual_distribution_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="s">'''Returns the probability density function of an unusual distribution.
    Derived analytically from unusual_distribution_cdf(). '''</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>     <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>    <span class="k">return</span> <span class="mf">0.5</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.98</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">1.96</span><span class="p">):</span> <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>    <span class="k">return</span> <span class="mf">0.25</span>
    <span class="k">else</span><span class="p">:</span>            <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">unusual_distribution_inverse_cdf</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="s">'''Returns the inverse cumulative density function of an unusual distribution.
    If you feed random numbers from 0 to 1 into this, it produces numbers that are
    effectively sampled from the probability density function.'''</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>                   <span class="k">return</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">):</span>               <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="mf">0.98</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">):</span> <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c"># 0.95125 = 0.5*0.95**2 + 0.5</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>                 <span class="k">return</span> <span class="mi">4</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>                         <span class="k">return</span> <span class="bp">None</span>
    
<span class="k">def</span> <span class="nf">calc_true_cdf</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">unusual_distribution_cdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">calc_true_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">unusual_distribution_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">sample_from_pdf</span><span class="p">(</span><span class="n">n_samps</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">unusual_distribution_inverse_cdf</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_samps</span><span class="p">)]</span>
</code></pre>
</div>

<p>Most people will prefer to simply plot the CDF and PDF and see what it looks like:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">calc_true_cdf</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"True CDF"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'black'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">calc_true_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"True PDF"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
</code></pre>
</div>

<p class="center"><img src="fig-01-true-distribution.png" alt="fig-01-true-distribution.png" title="The hidden, true distribution used to generate." /></p>

<p>We won’t need to show the CDF again – it was merely a visual guide to help see how to generate samples from the distribution. (It also is the same trick used when using percentiles to estimate a probability density function, as we shall see.)</p>

<p>For the rest of this article, we’ll use two collections of samples, which we’ll call A and B:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">n_samps</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">sample_from_pdf</span><span class="p">(</span><span class="n">n_samps</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">sample_from_pdf</span><span class="p">(</span><span class="n">n_samps</span><span class="p">)</span>
</code></pre>
</div>

<h2 id="problems-with-histograms">Problems with Histograms</h2>

<p>Building histograms on data A and data B will immediately highlight some of the problems with histograms:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">num_bins</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">calc_true_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"PDF"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">'step'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"Histogram for A"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"red"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">'step'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"Histogram for B"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"blue"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre>
</div>

<p class="center"><img src="fig-02-different-bins.png" alt="fig-02-different-bins.png" title="Samples A and B have different bin sizes." /></p>

<p>Several annoyances are obvious:</p>

<ul>
  <li>
    <p><strong>Histograms require assumptions about the range of the distribution.</strong> Histograms usually require that you choose a minimum, maximum, and number of bins with which to tile that range. When one doesn’t know <em>a priori</em> the min and max, it is common to use the limits of the sampled data, specify the number of bins, and then calculate the bin edges automatically. Unfortunately, this means that it is almost guaranteed that two sets of sampled data will have different bin edges, even when taken from the same distribution. In the above figure, you’ll note that the bin widths for A and B are different, because in sample set B, there were no points sampled around <script type="math/tex">x=2</script>.</p>
  </li>
  <li>
    <p><strong>Histograms are hard to combine or build incrementally.</strong> Let’s pretend that A is your existing estimate of the distribution, and B is a new batch of data that just came in. Furthermore, let’s imagine that you don’t want to recompute your histogram from scratch, but want to combine the histograms of A and B to produce a new histogram. How would you combine two histograms that have different bin widths and numbers of bins? While possible, I hope you can see that it would be awkward and leaves much to be desired.</p>
  </li>
  <li>
    <p><strong>Histograms obscure the shape of the data when there are large outliers.</strong> For illustration purposes, the little “sideband” around <script type="math/tex">x=2.0</script> is not that far from the main distribution. But you can imagine that if those outliers were at <script type="math/tex">x = 30</script> and the number of bins were fixed at <code class="highlighter-rouge">num_bins=30</code>, the range of the data would be so large that almost all of the data would fall in the first bin, and all others would be zero. Another way of stating this problem is the reverse: when you have lots of data in a single bin, you should theoretically be able to infer more about the internal structure of that bin. Unfortunately, when using a histogram, one can never resolve anything finer than a bin width.</p>
  </li>
</ul>

<p>Another, more subtle problem that we won’t get into today is that a histogram has a varying number of data points per bin. This means that your error bars (or confidence interval) on each bin will have different magnitudes. It is disappointingly rare for error bars on histograms to be plotted – but without error bars, it’s not science!</p>

<h2 id="quantile-estimated-pdfs">Quantile-Estimated PDFs</h2>

<p>We will now explore using quantiles to represent the sampled distribution, and see how that differs from the histogram representation. For those of you who have forgotten what a “quantile” is, it is just a generalization of the concept of a percentile. The basic concept of quantiles is to sort some data by value, and then sequentially group the sorted data into <script type="math/tex">N</script> equal-size groups. When <script type="math/tex">N=10</script> points, we call them “deciles”. When <script type="math/tex">N=100</script>, we call them percentiles. A list of percentiles of family income would give us 101 numbers (from 0% to 100%). The 0th percentile would be the lowest income, the 50th percentile would be the median, and the 100th percentile would indicate the maximum family income in the data set.</p>

<p>Let’s see how you could use the percentiles to generate a histogram-like plot. The basic idea is to use the precentiles to produce a cumulative distribution function, and then take a numerical derivative to get the probability density function.</p>

<p class="center"><img src="fig-03-concept.jpg" alt="fig-03-concept.jpg" title="The concept." /></p>

<p>Now let’s look at some code that will actually do this. To make the comparison between histograms and quantiles fair, we will use the same number of quantiles as we did histogram bins.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calc_quantiles</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num_quantiles</span><span class="p">):</span>
    <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">100.0</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="n">num_quantiles</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_quantiles</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">quantiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">quantiles</span>

<span class="n">num_quantiles</span> <span class="o">=</span> <span class="n">num_bins</span>
<span class="n">quantiles</span> <span class="o">=</span> <span class="n">calc_quantiles</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">num_quantiles</span><span class="p">)</span>

<span class="c"># To plot the percentiles as a histogram, we need to take the "derivative"</span>
<span class="c"># (actually, the first difference) and pad the ending with a near-zero value</span>
<span class="n">quantile_pdf</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_quantiles</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">quantiles</span><span class="p">),</span> <span class="mi">10</span><span class="o">**</span><span class="mi">10</span><span class="p">))</span>  

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">calc_true_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"True PDF"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">'step'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"Histogram of A"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"red"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">quantiles</span><span class="p">,</span> <span class="n">quantile_pdf</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">'post'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"Quantile-Estimated PDF of A"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"green"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre>
</div>

<p class="center"><img src="fig-03-quantiles-v-hist.png" alt="fig-03-quantiles-v-hist.png" title="Quantiles and Histogram estimates of PDF compared." /></p>

<p>There are several immediate things to notice about the quantile estimate:</p>

<ol>
  <li>
    <p>Rather than break up the estimate of the PDF into equal bin-widths on the X axis as the histogram did, <strong>the quantile-based estimate of the PDF divides the probability mass into equal-area rectangles</strong> that are squished and squashed to be short and wide or tall and thin. Around <script type="math/tex">x=0.1</script> there is a short and wide bin, and around <script type="math/tex">x=1.0</script> there are very tall and narrow rectangles.</p>
  </li>
  <li>
    <p>There appears to be more distance between the Quantile-estimated PDF and the true PDF than with the histogram around the <script type="math/tex">x=1.0</script> area. We’ll discuss whether this is really true or not in a moment, but it appears this way because the relative bin-widths of the quantile-estimated bins are smaller. The same effect would occur if we had used smaller bins for the histogram; it suggests that we may be able to use fewer quantile points than we would histogram bins.</p>
  </li>
  <li>
    <p>The quantile representation assumes that the distribution is continuous, so the “outliers” on the far right have now been spread out over the whole range <script type="math/tex">% <![CDATA[
1.0 < x < 2.0 %]]></script>. It ends up predicting such a low value that it is not very visible on this plot, but it is nonzero.</p>
  </li>
</ol>

<p>Point one is most important factor to keep in mind. With histograms, we give each bin an equal amount of information, regardless of how many points fall into it. With quantiles, we give each fraction of data the same amount of information.</p>

<h1 id="smoothing-with-gaussian-kernels">Smoothing with Gaussian Kernels</h1>

<p>Smoothing a histogram is often done with a kernel density estimate, which convolves a kernel across all the histogram bins. We can do something similar with quantile-estimated PDFs.</p>

<p>Let’s use percentiles for an example. Each percentile represents 1/100th of the whole data set. It is easy to imagine us placing 100 equal-area kernels, one over the barycenter of each percentile-bounded rectangle. Anything with unit area would work – rectangles, triangles, gaussians – but because of its smooth properties, we will select a unit-area gaussian as our kernel:</p>

<script type="math/tex; mode=display">g(x) = \frac{1}{\sigma \sqrt{2\pi}} \exp \left( \frac{1}{2} \left( \frac{x - \mu}{\sigma} \right) ^2 \right)</script>

<p>where</p>

<script type="math/tex; mode=display">\int_{\infty}^{\infty} g(x) dx = 1</script>

<p>We would then sum all of these unit-area gaussians together, and divide by the number of quantile bins. Graphically, the intuition looks like this:</p>

<p class="center"><img src="fig-04-smoothing.jpg" alt="fig-04-smoothing.jpg" title="Smoothing whiteboard. " /></p>

<p>As you can see in the figure above, the key intuition here is to scale the standard deviation <script type="math/tex">\sigma</script> according to the bin width. Tall, narrow bins produce tall, narrow gaussians. Short, wide bins produce short, wide unit gaussians. The code to do this is fairly straightforward:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Halfway between each two quantiles, put a unit-area gaussian kernel with a stddev (sigma) equal</span>
<span class="c"># to half the distance betwneen the two quantiles, scaled by smoothing factor K. </span>

<span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="s">'''Returns a smoothed PDF estimate'''</span>
    <span class="n">num_quantiles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">quantiles</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c"># Initialize "hi-rez" PDF to be zero</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_quantiles</span><span class="p">):</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">quantiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">quantiles</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">K</span><span class="o">*</span><span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span> <span class="o">+</span> <span class="n">p0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">sigma</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">sigma</span><span class="p">)):</span>
                <span class="k">continue</span>              <span class="c"># Skip because it's &gt;5 stddevs away</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pdf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

    <span class="n">pdf</span> <span class="o">=</span> <span class="n">pdf</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_quantiles</span><span class="p">)</span> <span class="c"># Rescale to unit area</span>
    
    <span class="k">return</span> <span class="n">pdf</span>

<span class="c"># To plot the percentiles, we need to take the derivative of it</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">calc_true_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"True PDF"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Smoothed Quantile-Estimated PDF (K=1)"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"blue"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">3.0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Smoothed Quantile-Estimated PDF (K=3)"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"purple"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">'step'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"Histogram of A"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"red"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


</code></pre>
</div>

<p class="center"><img src="fig-04-smoothed-quantiles.png" alt="fig-04-smoothed-quantiles.png" title="Smoothed quantiles. " /></p>

<p>This approach to smoothing is intuitively attractive, and to my eye the <code class="highlighter-rouge">K=3</code> smoothing level looks very pleasant. Using <script type="math/tex">K>1.0</script> allows one to express uncertainty about the measurements of <script type="math/tex">x</script>, and increases the smoothing of the estimated PDF.</p>

<p>But have we really accounted solved the right problem? While we know exactly the quantiles of the sampled data, we have uncertainty about the true quantiles. What if, instead of using a gaussian smoothing kernel, we computed our uncertainty on our estimates of the percentiles and generated an estimate based on that, instead?</p>

<p>One way to explore uncertainty of a sample is to the classic bootstrap technique. The following code generates bootstraps (from the quantile-estimated PDF, not from the original distribution!), which we can then use that uncertainty to scale the gaussian kernel widths:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">quantile_bootstrap</span><span class="p">(</span><span class="n">quantiles</span><span class="p">,</span> <span class="n">num_points_to_sample</span><span class="p">):</span>
    <span class="s">'''Returns a new set of data points bootstrapped from quantiles.'''</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">quantiles</span><span class="p">)</span>
    <span class="n">samps</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_points_to_sample</span><span class="p">)</span>
    <span class="n">bootstrap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">num_points_to_sample</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">samps</span><span class="p">):</span>
        <span class="n">i_bot</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">i_top</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">p_bot</span> <span class="o">=</span> <span class="n">quantiles</span><span class="p">[</span><span class="n">i_bot</span><span class="p">]</span>
        <span class="n">p_top</span> <span class="o">=</span> <span class="n">quantiles</span><span class="p">[</span><span class="n">i_top</span><span class="p">]</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">i_bot</span><span class="p">)</span>        
        <span class="n">bootstrap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_bot</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_top</span><span class="o">*</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>  <span class="c"># Linearly interpolate</span>
    <span class="k">return</span> <span class="n">bootstrap</span>

<span class="k">def</span> <span class="nf">bootstrapped_quantile_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">,</span> <span class="n">n_samps</span><span class="p">,</span> <span class="n">n_bootstraps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">confidence_interval</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
    <span class="s">'''Returns a smoothed PDF estimate that uses bootstraps of samples from the quantiles.'''</span>
    <span class="n">num_quantiles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">quantiles</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c"># Initialize "hi-rez" PDF to be zero</span>
    <span class="n">bootstraps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_bootstraps</span><span class="p">,</span> <span class="n">num_quantiles</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bootstraps</span><span class="p">):</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="n">quantile_bootstrap</span><span class="p">(</span><span class="n">quantiles</span><span class="p">,</span> <span class="n">n_samps</span><span class="p">)</span>
        <span class="n">bootstraps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_quantiles</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">num_quantiles</span><span class="p">)</span>

    <span class="n">bs</span> <span class="o">=</span> <span class="n">bootstraps</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">n_bootstraps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">quantiles</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c"># Count number of values in range:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span>
        <span class="n">pdf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">x0</span> <span class="o">&lt;</span> <span class="n">bs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bs</span> <span class="o">&lt;</span> <span class="n">x1</span><span class="p">))</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pdf</span>

<span class="c"># To plot the percentiles, we need to take the derivative of it</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">quantiles</span> <span class="o">=</span> <span class="n">calc_quantiles</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">num_quantiles</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">calc_true_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"PDF"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">bootstrapped_quantile_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">,</span> <span class="n">n_samps</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Bootstrapped PDF of A"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"green"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Smoothed PDF Estimate (K=1)"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"blue"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">'step'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"Histogram of A"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"red"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre>
</div>

<p class="center"><img src="fig-04-bootstrapped-quantiles.png" alt="fig-04-bootstrapped-quantiles.png" title="Bootstrapped quantiles. " /></p>

<p>Huh! That’s suprising. If I did that correctly (and I am not 100% sure that I did), it appears that the uncertainty about each percentile is indeed very gaussian, since it so closely resembles the <code class="highlighter-rouge">K=1</code> case. There is some small variation around the <script type="math/tex">x=-1.0</script> and <script type="math/tex">x=2.0</script> points, but otherwise it appears that we can just stick with simple gaussian kernel smoothing.</p>

<p>Depending on how you feel about boundaries, it might also be good to correct smoothing edge effects and redefine the <code class="highlighter-rouge">smoothed_pdf</code> function:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="s">'''Returns a smoothed PDF estimate of the quantiles.'''</span>
    <span class="n">num_quantiles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">quantiles</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c"># Initialize "hi-rez" PDF to be zero</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_quantiles</span><span class="p">):</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">quantiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">quantiles</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">K</span><span class="o">*</span><span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span> <span class="o">+</span> <span class="n">p0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">sigma</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">sigma</span><span class="p">)):</span>
                <span class="k">continue</span>               <span class="c"># Skip because it's very small</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pdf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

    <span class="c"># Wrap left side</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">xs</span> <span class="o">&lt;</span> <span class="n">quantiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">flipped_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">flipped_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flipped_idxs</span><span class="p">:</span>
        <span class="n">pdf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pdf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pdf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        
    <span class="c"># Wrap right side</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">xs</span> <span class="o">&gt;</span> <span class="n">quantiles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
        <span class="n">pdf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pdf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pdf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="n">pdf</span> <span class="o">=</span> <span class="n">pdf</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_quantiles</span><span class="p">)</span> <span class="c"># Rescale to unit area</span>
    
    <span class="k">return</span> <span class="n">pdf</span>

<span class="c"># To plot the percentiles, we need to take the derivative of it</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">calc_true_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"True PDF"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Smoothed Quantile-Estimated PDF (K=1)"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"blue"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">3.0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Smoothed Quantile-Estimated PDF (K=3)"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"green"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">'step'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"Histogram of A"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"red"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre>
</div>

<p class="center"><img src="fig-05-quantiles-v-hist-revised.png" alt="fig-05-quantiles-v-hist-revised.png" title="Quantiles and Histogram estimates of PDF compared." /></p>

<p>That looks good to my eye.</p>

<h2 id="combining-quantiles">Combining Quantiles</h2>

<p>Let us now imagine that we now want to combine the PDF estimate of samples A with the PDF estimate of samples B. How would you achieve that?</p>

<p>I can think of two ways:</p>

<ol>
  <li>Take the (weighted) mean of all the estimated PDFs.</li>
  <li>Combine the two lists of quantiles into a single list of quantiles.</li>
</ol>

<p>Let’s explore both approaches now.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">flatten_lists</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">l</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">combine_quantiles</span><span class="p">(</span><span class="n">list_of_quantiles</span><span class="p">,</span> <span class="n">list_of_n_samps</span><span class="p">,</span> <span class="n">num_quantiles</span><span class="p">):</span>
    <span class="s">'''Combines a list of quantiles of equal length into a single quantile set of length num_quantiles.'''</span>
    <span class="n">N_tot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">list_of_n_samps</span><span class="p">)</span>
    <span class="n">N_qs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">qs</span> <span class="ow">in</span> <span class="n">list_of_quantiles</span><span class="p">]</span>
    <span class="n">per_element_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">N</span> <span class="o">/</span> <span class="p">(</span><span class="n">N_tot</span> <span class="o">*</span> <span class="n">N_q</span><span class="p">)</span> <span class="k">for</span> <span class="n">N</span><span class="p">,</span> <span class="n">N_q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">list_of_n_samps</span><span class="p">,</span> <span class="n">N_qs</span><span class="p">)]</span>
    
    <span class="c"># Put all the values (except the 0th percentile) into sorted_quantiles, with weights</span>
    <span class="n">q_n_pairs</span> <span class="o">=</span> <span class="p">[[(</span><span class="n">q</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="k">for</span> <span class="n">qs</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">list_of_quantiles</span><span class="p">,</span> <span class="n">per_element_weights</span><span class="p">)]</span>
    <span class="n">sorted_quantiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">flatten_lists</span><span class="p">(</span><span class="n">q_n_pairs</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c"># For every new quantile...</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">flatten_lists</span><span class="p">(</span><span class="n">list_of_quantiles</span><span class="p">))</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="p">[</span><span class="n">xp</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">y_des</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">num_quantiles</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="c"># ...find the stairstepped point just before y_des...</span>
        <span class="n">y_stairs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">sorted_quantiles</span><span class="p">:</span>  <span class="c"># TODO: Start search where left off            </span>
            <span class="n">y_next</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_stairs</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">y_next</span> <span class="o">&lt;=</span> <span class="n">y_des</span><span class="p">):</span>
                <span class="n">xp</span> <span class="o">=</span> <span class="n">q</span>
                <span class="n">y_stairs</span> <span class="o">=</span> <span class="n">y_next</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c"># ...find the slope of the line that combines all other ramps after X</span>
        <span class="c"># y1 = A1 x + b1        # Find b1 such that y1 = A1 (x - q0)</span>
        <span class="c"># y2 = A2 x + b2        # Find b2 such that y2 = A2 </span>
        <span class="c"># ----------------------</span>
        <span class="c"># y = (A1+A2)x + (b1+b2)</span>
        <span class="c"># x = (y - (b1+b2)) / (A1+A2)</span>

        <span class="c"># To find the b1, b2, etc, we'll use the fact that at x = 0, y = (q0 - xp)</span>
        <span class="c">#    y = A x + b </span>
        <span class="c">#    q0-xp = A 0 + b</span>
        <span class="c">#    b = q0-xp</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">qs</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">list_of_quantiles</span><span class="p">,</span> <span class="n">per_element_weights</span><span class="p">):</span> <span class="c">## TODO: Search where left off</span>
            <span class="c"># Find the index of the first point less than</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">qs</span><span class="o">&gt;</span><span class="n">xp</span><span class="p">)</span>  <span class="c"># Find the first point greater or equal to xp</span>
            <span class="n">q0</span> <span class="o">=</span> <span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">q1</span> <span class="o">=</span> <span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">q1</span> <span class="o">-</span> <span class="n">q0</span><span class="p">)</span> <span class="o">/</span> <span class="n">w</span>
            <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">q0</span> <span class="o">-</span> <span class="n">xp</span><span class="p">)</span>
            <span class="n">slope</span> <span class="o">+=</span> <span class="n">a</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">b</span>

        <span class="c"># Now invert the cumulative set of lines to get x_des</span>
        <span class="n">x_des</span> <span class="o">=</span> <span class="p">((</span><span class="n">y_des</span> <span class="o">-</span> <span class="n">y_stairs</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span> <span class="o">/</span> <span class="n">slope</span>   <span class="c"># x = (y - (b1+b2)) / (A1+A2)</span>
        <span class="n">combined</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xp</span><span class="o">+</span><span class="n">x_des</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">combined</span>

<span class="k">def</span> <span class="nf">rastered_combination</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">list_of_quantiles</span><span class="p">):</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">list_of_quantiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">quantiles</span> <span class="ow">in</span> <span class="n">list_of_quantiles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">pdf</span> <span class="o">+=</span> <span class="n">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">)</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">pdf</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_quantiles</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pdf</span>

<span class="n">A_quantiles</span> <span class="o">=</span> <span class="n">calc_quantiles</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">num_quantiles</span><span class="p">)</span>
<span class="n">B_quantiles</span> <span class="o">=</span> <span class="n">calc_quantiles</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">num_quantiles</span><span class="p">)</span>
<span class="n">AB_quantiles</span> <span class="o">=</span> <span class="n">calc_quantiles</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">]),</span> <span class="n">num_quantiles</span><span class="p">)</span>
<span class="n">combined_quantiles</span> <span class="o">=</span> <span class="n">combine_quantiles</span><span class="p">([</span><span class="n">A_quantiles</span><span class="p">,</span> <span class="n">B_quantiles</span><span class="p">],</span> <span class="p">[</span><span class="n">n_samps</span><span class="p">,</span> <span class="n">n_samps</span><span class="p">],</span> <span class="n">num_quantiles</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">calc_true_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"True PDF"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">A_quantiles</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Dataset A"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"orange"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">B_quantiles</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Dataset B"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"yellow"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">AB_quantiles</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Dataset AB"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"green"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">rastered_combination</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="p">[</span><span class="n">A_quantiles</span><span class="p">,</span> <span class="n">B_quantiles</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s">"A+B Estimate"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"blue"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">combined_quantiles</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Combined Estimate"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"purple"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">'step'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"Histogram of A"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"red"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre>
</div>

<p class="center"><img src="fig-05-combinations.png" alt="fig-05-combinations.png" title="Combining data sets A and B." /></p>

<p>Apologies for the busy plot, but there’s a lot to see here. At this stage, I’m not sure which combination method should be used in general – it may depend on your application.</p>

<p>Combining lists of quantiles may be worth may be worth studying further in the future.</p>

<h2 id="what-happens-as-you-get-more-data">What happens as you get more data?</h2>

<p>This is a simple experiment: simply keep the number of histogram bins and quantiles constant at 50, increase the number of data points, and see what happens.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">n</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">num_bins</span> <span class="o">=</span> <span class="mi">50</span>

<span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">20000</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sample_from_pdf</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">quantiles</span> <span class="o">=</span> <span class="n">calc_quantiles</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">)</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">calc_true_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"True PDF"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Quantile-Estimated PDF"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"blue"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">'step'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"Histogram"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"red"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'{} Data Points, {} Bins (or Quantiles)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">*</span><span class="mi">2</span>
</code></pre>
</div>

<p class="center"><img src="fig-06-200-samps.png" alt="fig-06-200-samps.png" title="200 data points." /></p>

<p class="center"><img src="fig-06-400-samps.png" alt="fig-06-400-samps.png" title="400 data points." /></p>

<p class="center"><img src="fig-06-800-samps.png" alt="fig-06-800-samps.png" title="800 data points." /></p>

<p class="center"><img src="fig-06-1600-samps.png" alt="fig-06-1600-samps.png" title="1600 data points." /></p>

<p class="center"><img src="fig-06-3200-samps.png" alt="fig-06-3200-samps.png" title="3200 data points." /></p>

<p class="center"><img src="fig-06-6400-samps.png" alt="fig-06-6400-samps.png" title="6400 data points." /></p>

<h2 id="what-happens-if-we-try-fewer-and-fewer-bins">What happens if we try fewer and fewer bins?</h2>

<p>This is another easy one to try:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">n</span> <span class="o">=</span> <span class="mi">1600</span>
<span class="n">num_bins</span> <span class="o">=</span> <span class="mi">50</span>

<span class="k">while</span> <span class="n">num_bins</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sample_from_pdf</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">quantiles</span> <span class="o">=</span> <span class="n">calc_quantiles</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">)</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">calc_true_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"True PDF"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">smoothed_pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Quantile-Estimated PDF"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"blue"</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">'step'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"Histogram"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"red"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'{} Data Points, {} Bins (or Quantiles)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">))</span>
    <span class="n">num_bins</span> <span class="o">=</span> <span class="n">num_bins</span> <span class="o">-</span> <span class="mi">10</span>
</code></pre>
</div>

<p class="center"><img src="fig-07-50-bins.png" alt="fig-07-50-bins.png" title="50 bins." /></p>

<p class="center"><img src="fig-07-40-bins.png" alt="fig-07-40-bins.png" title="40 bins." /></p>

<p class="center"><img src="fig-07-30-bins.png" alt="fig-07-30-bins.png" title="30 bins." /></p>

<p class="center"><img src="fig-07-20-bins.png" alt="fig-07-20-bins.png" title="20 bins." /></p>

<p class="center"><img src="fig-07-10-bins.png" alt="fig-07-10-bins.png" title="10 bins." /></p>

<h2 id="expressing-uncertainty-and-confidence-interval">Expressing Uncertainty and Confidence Interval</h2>

<p>I haven’t tried making confidence intervals for the histogram yet, but my guess is that we could express uncertainty by taking a lot of bootstraps, generate many CDFs, and then taking the top 95% or bottom 5% value at each X coordinate.</p>

<p>TODO.</p>

<h2 id="conclusion">Conclusion</h2>

<p>The difference between the histogram and quantile technique is primarily in how information is used. In histograms, we give each bin an equal amount of information (i.e. one number per bin), regardless of how many points fall into it. In quantiles, we give each fraction of data the same amount of information (i.e. about one number per percentile).</p>

<p>The quantile method has a few advantages:</p>

<ol>
  <li>It better captures the structure of the distribution better in high density areas.</li>
  <li>It allows variable-density smoothing.</li>
  <li>It can help reduce the visual effect of outliers.</li>
</ol>

<p>The quantile method also has disadvantages:</p>

<ol>
  <li>It cannot represent completely disconnected distributions, such as near <script type="math/tex">x=2.0</script> in this example.</li>
  <li>Visually, the relatively higher density of control points compared to the histogram means that quantile-based estimates of the PDF appear to be more variable. The solution to this may simply be to use fewer quantiles.</li>
</ol>

<h2 id="references">References</h2>

<ol>
  <li><a href="https://suchideas.com/articles/maths/applied/histogram-errors/">https://suchideas.com/articles/maths/applied/histogram-errors/</a></li>
  <li><a href="https://arxiv.org/pdf/1112.2593v3.pdf">https://arxiv.org/pdf/1112.2593v3.pdf</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Bootstrapping_(statistics)">Bootstrap Hypothesis Testing</a></li>
</ol>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/blog/jupyter-quick-install/" class="btn" title="Jupyter Quick Install for Scientists">Previous</a>
      
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<div>&copy; 2019 Ivar Thorson. </div>
<div class="legaltext">Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using a modified version of the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.</div>
<div class="social-icons">
	<a href="https://twitter.com/ivarthorson" title="Ivar Thorson on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	
	
	
	
	
	
	<a href="https://github.com/ivarthorson" title="Ivar Thorson on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  
	
  <a href="/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = '';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>




</body>
</html>
