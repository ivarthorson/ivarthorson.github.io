<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Project Euler Problem 59 &#8211; Art is Never Finished</title>
<meta name="description" content="Another fun one! Problem 59 reminds me of those long-past days when I was a young boy, heavily armed with water pistols and secure in my friend’s tree house, trying to develop secret alphabets and substitutions ciphers to keep our secret documents out of the hands of our evil sisters, who generally had no interest in what we were writing anyway.

">
<meta name="keywords" content="decryption, pmap, xor">


<!-- Twitter Cards -->
<meta name="twitter:title" content="Project Euler Problem 59">
<meta name="twitter:description" content="Another fun one! Problem 59 reminds me of those long-past days when I was a young boy, heavily armed with water pistols and secure in my friend’s tree house, trying to develop secret alphabets and substitutions ciphers to keep our secret documents out of the hands of our evil sisters, who generally had no interest in what we were writing anyway.

">
<meta name="twitter:site" content="@ivarthorson">
<meta name="twitter:creator" content="@ivarthorson">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Project Euler Problem 59">
<meta property="og:description" content="Another fun one! Problem 59 reminds me of those long-past days when I was a young boy, heavily armed with water pistols and secure in my friend’s tree house, trying to develop secret alphabets and substitutions ciphers to keep our secret documents out of the hands of our evil sisters, who generally had no interest in what we were writing anyway.

">
<meta property="og:url" content="/project-euler/problem-59/">
<meta property="og:site_name" content="Art is Never Finished">





<link rel="canonical" href="/project-euler/problem-59/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Art is Never Finished Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="/assets/js/vendor/html5shiv.min.js"></script>
  <script src="/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="/about/" >About</a></li>
		  
		    
		    <li><a href="/blog/" >Blog</a></li>
		  
		    
		    <li><a href="/project-euler/" >Code</a></li>
		  
		    
		    <li><a href="/search/" >Search</a></li>
		  
		    
		    <li><a href="/tags/" >Tags</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title animated fadeIn"><a href="/">Art is Never Finished</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">...Only Abandoned. – Leonardo da Vinci</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="/tags/#decryption" title="Pages tagged decryption">decryption</a></li><li><a href="/tags/#pmap" title="Pages tagged pmap">pmap</a></li><li><a href="/tags/#xor" title="Pages tagged xor">xor</a></li>
        </ul>
        
          <h1 class="entry-title">Project Euler Problem 59</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/ivar.jpg" class="bio-photo" alt="Ivar Thorson bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Ivar Thorson</span></span>
        <span class="entry-date date published"><time datetime="2010-08-19T10:20:55-07:00"><i class="fa fa-calendar-o"></i> August 19, 2010</time></span>
        
        
        
        
      </footer>
      <div class="entry-content">
        <p>Another fun one! <a href="http://projecteuler.net/index.php?section=problems&amp;id=59">Problem 59</a> reminds me of those long-past days when I was a young boy, heavily armed with water pistols and secure in my friend’s tree house, trying to develop secret alphabets and substitutions ciphers to keep our secret documents out of the hands of our evil sisters, who generally had no interest in what we were writing anyway.</p>

<p>But wait! This problem gives us a secret message stolen straight from the sisters’ secret laboratory. Let’s see if we can’t first break the simple rotating XOR cipher of this problem using sheer brute force. Since we know the keylength (3), and that the key is lowercase ASCII and the text is also mostly lowercase ascii, this will be a very easy task indeed. We’ll just try to find the particular keys which maximize the number of ascii characters present in the decoded message.</p>

<pre><code>(<span style="color: #8ae234;">defn</span> <span style="color: #edd400; font-weight: bold;">num-ascii-chars</span> 
  <span style="color: #888a85;">"Returns the number of ascii characters found in string s."</span>
  [s]
  (<span style="color: #729fcf;">count</span> (<span style="color: #729fcf;">filter</span> #(<span style="color: #8ae234;">or</span> (<span style="color: #8ae234;">and</span> (<span style="color: #729fcf;">&lt;=</span> (<span style="color: #729fcf;">int</span> \a) %) (<span style="color: #729fcf;">&lt;=</span> % (<span style="color: #729fcf;">int</span> \z)))
                      (<span style="color: #8ae234;">and</span> (<span style="color: #729fcf;">&lt;=</span> (<span style="color: #729fcf;">int</span> \A) %) (<span style="color: #729fcf;">&lt;=</span> % (<span style="color: #729fcf;">int</span> \Z)))
                      (<span style="color: #729fcf;">=</span> (<span style="color: #729fcf;">int</span> \newline) %)
                      (<span style="color: #729fcf;">=</span> (<span style="color: #729fcf;">int</span> \space) %))
                 (<span style="color: #729fcf;">map</span> #(<span style="color: #729fcf;">int</span> %) s))))

(<span style="color: #8ae234;">defn</span> <span style="color: #edd400; font-weight: bold;">decrypt-xor</span>
  <span style="color: #888a85;">"Try to decrypt integer seq s with cyclically repeating key k."</span>
  [s k]
  (<span style="color: #729fcf;">map</span> bit-xor s (<span style="color: #729fcf;">cycle</span> k)))

(<span style="color: #8ae234;">defn</span> <span style="color: #edd400; font-weight: bold;">euler-59</span> [file]
  (<span style="color: #8ae234;">let</span> [chars (<span style="color: #729fcf;">map</span> #(Integer/parseInt %) (<span style="color: #729fcf;">re-seq</span> #<span style="color: #Fd7f98;">"\d+"</span> (<span style="color: #729fcf;">rp</span> file)))
        lowers (<span style="color: #729fcf;">map</span> #(<span style="color: #729fcf;">int</span> %) <span style="color: #Fd7f98;">"abcdefghijklmnopqrstuvwxyz"</span>)
        best-match (<span style="color: #729fcf;">reduce</span>
                    #(<span style="color: #8ae234;">if</span> (<span style="color: #729fcf;">&gt;</span> (<span style="color: #729fcf;">second</span> %1) (<span style="color: #729fcf;">second</span> %2)) %1 %2)
                    (<span style="color: #8ae234;">for</span> [a lowers
                          b lowers
                          c lowers]
                      [(<span style="color: #729fcf;">str</span> (<span style="color: #729fcf;">char</span> a) (<span style="color: #729fcf;">char</span> b) (<span style="color: #729fcf;">char</span> c))
                       (num-ascii-chars (decrypt-xor chars [a b c]))]))
        decrypted (decrypt-xor chars (<span style="color: #729fcf;">map</span> #(<span style="color: #729fcf;">int</span> %) (<span style="color: #729fcf;">first</span> best-match)))]
    (<span style="color: #729fcf;">println</span> <span style="color: #Fd7f98;">"key: "</span> best-match)
    (<span style="color: #729fcf;">println</span> <span style="color: #Fd7f98;">"decrypted: "</span> (<span style="color: #729fcf;">apply</span> str (<span style="color: #729fcf;">map</span> #(<span style="color: #729fcf;">char</span> %) decrypted)))
    (<span style="color: #729fcf;">reduce</span> + decrypted)))

(<span style="color: #729fcf;">time</span> (euler-59 <span style="color: #Fd7f98;">"/path/to/cipher1.txt"</span>)) <span style="color: #A8AaA5;">;; </span><span style="color: #A8AaA5;">"Elapsed time: 21275.297615 msecs"
</span></code></pre>

<p>We were able to safely decrypt the encrypted message (obviously a red herring planted to disguise their true intentions…it mentions nothing about an attack on our fortified encampment) in under a minute this time, but what if our scheming sisters start using longer keys with which to communicate amongst themselves? The complexity of this type of exhaustive search is going to grow exponentially with each new digit they add! We will be buried in computational complexity long before we learn of their true plans.</p>

<p>We need to find an algorithm that works in linear time if possible, and improve the scoring system that we have been using. A simple way to do this for substitution ciphers is to perform a <a href="http://en.wikipedia.org/wiki/Frequency_analysis">letter frequency analysis</a>; in written English, vowels appear far more often than consonants like q or z, and we can make use of this fact to select the letter that maximizes the likelihood of the decrypted text having a letter frequency similar to English.</p>

<p>Since we know that our particular rotating cipher uses a 3-letter key, we can make three lists and solve for each digit independently. The most likely candidate for the key is thus the letter that maximizes the letter frequency probability when XOR’d over the list.</p>

<pre><code>(<span style="color: #8ae234;">def</span> <span style="color: #edd400; font-weight: bold;">letters</span> <span style="color: #Fd7f98;">"abcdefghijklmnopqrstuvwxyz"</span>) 

<span style="color: #A8AaA5;">;; </span><span style="color: #A8AaA5;">For English text. From http://en.wikipedia.org/wiki/Letter_frequency
</span>(<span style="color: #8ae234;">def</span> <span style="color: #edd400; font-weight: bold;">letter-freq</span> {\a 11.602, \b 4.702, \c 3.511, \d 2.670, \e 2.000,
                  \f 3.779,  \g 1.950, \h 7.232, \i 6.286, \j 0.631,
                  \k 0.690,  \l 2.705, \m 4.374, \n 2.365, \o 6.264,
                  \p 2.545,  \q 0.173, \r 1.653, \s 7.755, \t 16.671
                  \u 1.487,  \v 0.619, \w 6.661, \x 0.005, \y 1.620,
                  \z 0.050})

(<span style="color: #8ae234;">defn</span> <span style="color: #edd400; font-weight: bold;">xor-chars</span> [a b]
  (<span style="color: #729fcf;">char</span> (<span style="color: #729fcf;">bit-xor</span> (<span style="color: #729fcf;">int</span> a) (<span style="color: #729fcf;">int</span> b))))

(<span style="color: #8ae234;">defn</span> <span style="color: #edd400; font-weight: bold;">char-score</span> [c s]
  (<span style="color: #729fcf;">reduce</span> + (<span style="color: #729fcf;">remove</span> nil? (<span style="color: #729fcf;">map</span> #(letter-freq (xor-chars % c)) s))))

(<span style="color: #8ae234;">defn</span> <span style="color: #edd400; font-weight: bold;">best-char</span> [s]
  (<span style="color: #729fcf;">first</span> (<span style="color: #729fcf;">first</span> (<span style="color: #729fcf;">sort-by</span> val &gt; (zipmap letters
                                       (<span style="color: #729fcf;">map</span> #(char-score % s) letters))))))

(<span style="color: #8ae234;">defn</span> <span style="color: #edd400; font-weight: bold;">euler-59-revised</span> [keylength file]
  (<span style="color: #8ae234;">let</span> [msg (<span style="color: #729fcf;">map</span> #(<span style="color: #729fcf;">char</span> (Integer/parseInt %)) (<span style="color: #729fcf;">re-seq</span> #<span style="color: #Fd7f98;">"\d+"</span> (<span style="color: #729fcf;">rp</span> file)))
        ks (<span style="color: #729fcf;">apply</span> str (<span style="color: #8ae234;">for</span> [k (<span style="color: #729fcf;">range</span> 0 keylength)]
                        (best-char (<span style="color: #729fcf;">take-nth</span> keylength (<span style="color: #729fcf;">drop</span> k msg)))))
        decrypted (<span style="color: #729fcf;">apply</span> str (<span style="color: #729fcf;">map</span> xor-chars msg (<span style="color: #729fcf;">cycle</span> ks)))]
    (<span style="color: #729fcf;">println</span> <span style="color: #Fd7f98;">"key: "</span> ks)
    (<span style="color: #729fcf;">println</span> <span style="color: #Fd7f98;">"decrypted: "</span> decrypted)
    (<span style="color: #729fcf;">reduce</span> + (<span style="color: #729fcf;">map</span> #(<span style="color: #729fcf;">int</span> %) decrypted))))

(<span style="color: #729fcf;">time</span> (euler-59-revised 3 <span style="color: #Fd7f98;">"/zzz/work/cipher1.txt"</span>))
<span style="color: #A8AaA5;">;; </span><span style="color: #A8AaA5;">"Elapsed time: 27.96454 msecs"
</span></code></pre>

<p>Much better! Now if those pesky girls add extra digits to their rotating XOR cipher, it only adds a linear increase in complexity to our decoding operation.</p>

<p>As an aside: getting the key with the maximum value out of a hash map isn’t as straightforward as I would like. For the curious, here is another idiom for computing <code class="highlighter-rouge">best-char</code>:</p>

<pre><code>(<span style="color: #8ae234;">defn</span> <span style="color: #edd400; font-weight: bold;">best-char</span> [s]
  (<span style="color: #729fcf;">first</span> (<span style="color: #729fcf;">apply</span> max-key second (zipmap letters (<span style="color: #729fcf;">map</span> #(char-score % s) letters)))))</code></pre>

<p>And for our final trick, we can avoid even the linear increase in computation time by performing the computation of all the digits in parallel, meaning that finding keys up to n-digits long (where n is the number of cores in your computer) will take roughly the same amount of time as it takes to find a 3-digit key.</p>

<p>Here’s our final version, with the <code class="highlighter-rouge">println</code>’s stripped out and a <code class="highlighter-rouge">pmap</code> introduced. Note the single-character difference between the sequential version and the parallel version:</p>

<pre><code>(<span style="color: #8ae234;">defn</span> <span style="color: #edd400; font-weight: bold;">euler-59-sequential</span> [keylength file]
  (<span style="color: #8ae234;">let</span> [msg (<span style="color: #729fcf;">map</span> #(<span style="color: #729fcf;">char</span> (Integer/parseInt %)) (<span style="color: #729fcf;">re-seq</span> #<span style="color: #Fd7f98;">"\d+"</span> (<span style="color: #729fcf;">rp</span> file)))
        ks (<span style="color: #729fcf;">map</span> (<span style="color: #729fcf;">fn</span> [k] (best-char  (<span style="color: #729fcf;">take-nth</span> keylength (<span style="color: #729fcf;">drop</span> k msg))))
                 (<span style="color: #729fcf;">range</span> 0 keylength))
        decrypted (<span style="color: #729fcf;">apply</span> str (<span style="color: #729fcf;">map</span> xor-chars msg (<span style="color: #729fcf;">cycle</span> ks)))]
    (<span style="color: #729fcf;">reduce</span> + (<span style="color: #729fcf;">map</span> #(<span style="color: #729fcf;">int</span> %) decrypted))))

(<span style="color: #8ae234;">defn</span> <span style="color: #edd400; font-weight: bold;">euler-59-parallel</span> [keylength file]
  (<span style="color: #8ae234;">let</span> [msg (<span style="color: #729fcf;">map</span> #(<span style="color: #729fcf;">char</span> (Integer/parseInt %)) (<span style="color: #729fcf;">re-seq</span> #<span style="color: #Fd7f98;">"\d+"</span> (<span style="color: #729fcf;">rp</span> file)))
        ks (<span style="color: #729fcf;">pmap</span> (<span style="color: #729fcf;">fn</span> [k] (best-char  (<span style="color: #729fcf;">take-nth</span> keylength (<span style="color: #729fcf;">drop</span> k msg))))
                 (<span style="color: #729fcf;">range</span> 0 keylength))
        decrypted (<span style="color: #729fcf;">apply</span> str (<span style="color: #729fcf;">map</span> xor-chars msg (<span style="color: #729fcf;">cycle</span> ks)))]
    (<span style="color: #729fcf;">reduce</span> + (<span style="color: #729fcf;">map</span> #(<span style="color: #729fcf;">int</span> %) decrypted))))

(<span style="color: #8ae234;">dotimes</span> [_ 5]
  (<span style="color: #729fcf;">time</span> (euler-59-sequential 3 <span style="color: #Fd7f98;">"/zzz/work/cipher1.txt"</span>)))

<span style="color: #Fd7f98;">"Elapsed time: 26.849201 msecs"</span>
<span style="color: #Fd7f98;">"Elapsed time: 25.795924 msecs"</span>
<span style="color: #Fd7f98;">"Elapsed time: 25.956343 msecs"</span>
<span style="color: #Fd7f98;">"Elapsed time: 26.187312 msecs"</span>
<span style="color: #Fd7f98;">"Elapsed time: 29.941494 msecs"</span>


(<span style="color: #8ae234;">dotimes</span> [_ 5]
  (<span style="color: #729fcf;">time</span> (euler-59-parallel 3 <span style="color: #Fd7f98;">"/zzz/work/cipher1.txt"</span>)))
<span style="color: #Fd7f98;">"Elapsed time: 11.838932 msecs"</span>
<span style="color: #Fd7f98;">"Elapsed time: 11.529343 msecs"</span>
<span style="color: #Fd7f98;">"Elapsed time: 19.139515 msecs"</span>
<span style="color: #Fd7f98;">"Elapsed time: 11.350502 msecs"</span>
<span style="color: #Fd7f98;">"Elapsed time: 10.873593 msecs"</span></code></pre>

<p>A simple change has more than doubled the speed of the algorithm, although not quite to the 3x faster. Regardless, we are roughly 2000 times faster than our original naive implementation!</p>

<p>The taste of success brought on by efficient, parallel decryption has bolstered my juvenile mood and I will now take this moment to laugh maniacally: Muhuhuhahahaha!</p>


        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/project-euler/problem-58/" class="btn" title="Project Euler Problem 58">Previous</a>
      
      
        <a href="/project-euler/problem-60/" class="btn" title="Project Euler Problem 60">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<div>&copy; 2019 Ivar Thorson. </div>
<div class="legaltext">Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using a modified version of the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.</div>
<div class="social-icons">
	<a href="https://twitter.com/ivarthorson" title="Ivar Thorson on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	
	
	
	
	
	
	<a href="https://github.com/ivarthorson" title="Ivar Thorson on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  
	
  <a href="/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = '';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>




</body>
</html>
